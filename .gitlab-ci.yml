# Ref https://docs.gitlab.com/ee/ci/yaml/index.html

cache:
  key: sdx
  paths:
    - sdx

stages:
  - build

variables:
  SCALEIMP_VER: "1.0.0"
  SCALEIMP_DEBIAN_EPOCH: "1"

.win_template:
  stage: build
  tags:
    - windows
  before_script:
    - If (Test-Path -Path sdx)  {
        Write-Output "sdx was cached"
      } else {
        curl https://chiselapp.com/user/aspect/repository/sdx/uv/sdx-20110317.kit
          -o sdx
      }
  artifacts:
    paths:
      - scaleimp.exe

win-x86_64:
  extends: .win_template
  tags:
    - windows
  script:
    - tclkits-prebuilt/tclkit-cli-8_6_11-twapi-4_5_2-x64-max.exe build.tcl
        --no-gui
        --build-kit=./tclkits-prebuilt/tclkit-cli-8_6_11-twapi-4_5_2-x64-max.exe
        --runtime-kit=./tclkits-prebuilt/tclkit-gui-8_6_11-twapi-4_5_2-x64-max.exe
  artifacts:
    name: "scaleimp-windows-64.exe"

win-x86_32:
  extends: .win_template
  tags:
    - windows
  script:
    - tclkits-prebuilt/tclkit-cli-8_6_11-twapi-4_5_2-x86-max.exe build.tcl
        --no-gui
        --build-kit=./tclkits-prebuilt/tclkit-cli-8_6_11-twapi-4_5_2-x86-max.exe
        --runtime-kit=./tclkits-prebuilt/tclkit-gui-8_6_11-twapi-4_5_2-x86-max.exe
  artifacts:
    name: "scaleimp-windows-32.exe"

.unix_deps:
  stage: build
  before_script:
    - (test -f sdx && echo "sdx was cached") ||
      curl https://chiselapp.com/user/aspect/repository/sdx/uv/sdx-20110317.kit
        -o sdx

debian:
  extends: .unix_deps
  image: debian:11
  before_script:
    - apt-get update -y
    - apt-get install debhelper dpkg-dev tk -y
  script:
#FIXME: Sign the package by getting the signing key from some keyvault?
    - dpkg-buildpackage -b --no-sign
    - mv ../scaleimp_* . #Artifacts are produced outside pwd - GitLab artifacts must be inside pwd
  artifacts:
    name: "scaleimp_${SCALEIMP_VER}-${SCALEIMP_DEBIAN_EPOCH}_all_debian"
    paths:
      - "scaleimp_${SCALEIMP_VER}-${SCALEIMP_DEBIAN_EPOCH}_all.deb"
  after_script:
    - ls
    - ls ..
    - dpkg -i scaleimp_${SCALEIMP_VER}-${SCALEIMP_DEBIAN_EPOCH}_all.deb

fedora:
  extends: .unix_deps
  image: fedora:35
  before_script:
    - mkdir -p ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
    - cp fedora/scaleimp.spec ~/rpmbuild/SPECS
  script:
    - dnf install -y rpm-build tk make
    - rpmbuild --undefine=_disable_source_fetch -bs ~/rpmbuild/SPECS/scaleimp.spec
    - rpmbuild --undefine=_disable_source_fetch -ba ~/rpmbuild/SPECS/scaleimp.spec
    - cp -v ~/rpmbuild/RPMS/noarch/scaleimp-*.rpm . #can't upload artifacts outside pwd
  artifacts:
    name: "scaleimp-$SCALEIMP_VER-fedora"
    paths:
      - "*.rpm"
  after_script:
    - ls ~/rpmbuild/RPMS/noarch/ || true
    - rpm -i ~/rpmbuild/RPMS/noarch/scaleimp-*.rpm
